const express = require('express');
const axios = require('axios');
const cors = require('cors');

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Root endpoint
app.get('/', (req, res) => {
  res.json({
    message: 'URL Expander API',
    endpoints: {
      expand: {
        method: 'POST',
        path: '/api/expand',
        body: { url: 'short_url_here' }
      },
      expandGet: {
        method: 'GET',
        path: '/api/expand?url=short_url_here'
      }
    }
  });
});

// Expand URL endpoint - POST
app.post('/api/expand', async (req, res) => {
  try {
    const { url } = req.body;

    if (!url) {
      return res.status(400).json({
        error: 'URL is required',
        message: 'Please provide a URL in the request body'
      });
    }

    // Validate URL format
    if (!isValidUrl(url)) {
      return res.status(400).json({
        error: 'Invalid URL format',
        message: 'Please provide a valid URL'
      });
    }

    const expandedUrl = await expandUrl(url);

    res.json({
      success: true,
      shortUrl: url,
      expandedUrl: expandedUrl,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('Error expanding URL:', error.message);
    res.status(500).json({
      error: 'Failed to expand URL',
      message: error.message
    });
  }
});

// Expand URL endpoint - GET
app.get('/api/expand', async (req, res) => {
  try {
    const { url } = req.query;

    if (!url) {
      return res.status(400).json({
        error: 'URL is required',
        message: 'Please provide a URL as a query parameter: /api/expand?url=your_url'
      });
    }

    // Validate URL format
    if (!isValidUrl(url)) {
      return res.status(400).json({
        error: 'Invalid URL format',
        message: 'Please provide a valid URL'
      });
    }

    const expandedUrl = await expandUrl(url);

    res.json({
      success: true,
      shortUrl: url,
      expandedUrl: expandedUrl,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('Error expanding URL:', error.message);
    res.status(500).json({
      error: 'Failed to expand URL',
      message: error.message
    });
  }
});

// Function to expand URL by following redirects
async function expandUrl(shortUrl) {
  try {
    // Make a HEAD request first (lighter than GET)
    const response = await axios.head(shortUrl, {
      maxRedirects: 10,
      validateStatus: function (status) {
        return status >= 200 && status < 400; // Accept redirects and success
      },
      timeout: 10000 // 10 second timeout
    });

    // Return the final URL after following all redirects
    return response.request.res.responseUrl || shortUrl;

  } catch (error) {
    // If HEAD fails, try GET request
    try {
      const response = await axios.get(shortUrl, {
        maxRedirects: 10,
        validateStatus: function (status) {
          return status >= 200 && status < 400;
        },
        timeout: 10000
      });

      return response.request.res.responseUrl || shortUrl;

    } catch (getError) {
      throw new Error(`Unable to expand URL: ${getError.message}`);
    }
  }
}

// Validate URL format
function isValidUrl(string) {
  try {
    const url = new URL(string);
    return url.protocol === 'http:' || url.protocol === 'https:';
  } catch (err) {
    return false;
  }
}

// Start server
app.listen(PORT, () => {
  console.log(`URL Expander API is running on http://localhost:${PORT}`);
  console.log(`Try POST http://localhost:${PORT}/api/expand with body: { "url": "short_url" }`);
  console.log(`Or GET http://localhost:${PORT}/api/expand?url=short_url`);
});
